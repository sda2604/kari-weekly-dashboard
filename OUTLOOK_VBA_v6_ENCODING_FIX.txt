'===============================================================================
' KARI OUTLOOK VBA MACRO v6.0 - ENCODING FIX
'===============================================================================
' CRITICAL FIX: Use PropertyAccessor to read Subject in correct encoding
' Date: 03.02.2026
'
' CHANGELOG v6.0:
' - FIXED: Subject encoding using PropertyAccessor
' - ADDED: GetSubjectSafe() function with multiple fallbacks
' - IMPROVED: More robust matching patterns
'===============================================================================

Option Explicit

Private Const SAVE_PATH As String = "C:\Users\salni\Desktop\Данные для Claude\WORK\2025-01-22_Автоматизация_еженедельных_отчетов\input\"
Private Const LOG_PATH As String = "C:\Users\salni\Desktop\Данные для Claude\WORK\2025-01-22_Автоматизация_еженедельных_отчетов\logs\"
Private Const SHOW_DEBUG As Boolean = False
Private Const ENABLE_LOGGING As Boolean = True

'===============================================================================
' GET SUBJECT SAFELY - FIX FOR CYRILLIC ENCODING
' This is THE CRITICAL FIX!
'===============================================================================
Private Function GetSubjectSafe(ByRef objMail As Outlook.MailItem) As String
    On Error Resume Next
    
    Dim strSubject As String
    
    ' Method 1: PropertyAccessor (most reliable)
    strSubject = objMail.PropertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x0037001F")
    
    ' Method 2: ConversationTopic (fallback)
    If strSubject = "" Or Err.Number <> 0 Then
        Err.Clear
        strSubject = objMail.ConversationTopic
    End If
    
    ' Method 3: Subject (last resort)
    If strSubject = "" Or Err.Number <> 0 Then
        Err.Clear
        strSubject = objMail.Subject
    End If
    
    GetSubjectSafe = strSubject
    On Error GoTo 0
End Function

'===============================================================================
' MAIN - Application_NewMailEx event
'===============================================================================
Private Sub Application_NewMailEx(ByVal EntryIDCollection As String)
    Dim objNS As Outlook.NameSpace
    Dim objMail As Outlook.MailItem
    Dim objAttachment As Outlook.Attachment
    Dim arrIDs() As String
    Dim strID As Variant
    Dim strSubject As String
    Dim strMatchType As String
    Dim strFileName As String
    Dim strFullPath As String
    Dim strSubFolder As String
    Dim intSavedCount As Integer
    Dim strDebugInfo As String

    On Error GoTo ErrorHandler

    Set objNS = Application.GetNamespace("MAPI")
    If Not FolderExists(SAVE_PATH) Then MkDir SAVE_PATH
    If Not FolderExists(LOG_PATH) Then MkDir LOG_PATH

    arrIDs = Split(EntryIDCollection, ",")

    For Each strID In arrIDs
        Set objMail = objNS.GetItemFromID(Trim(strID))

        If TypeName(objMail) = "MailItem" Then
            ' CRITICAL: Use GetSubjectSafe instead of objMail.Subject
            strSubject = GetSubjectSafe(objMail)
            
            strDebugInfo = "=== NEW EMAIL ===" & vbCrLf & _
                          "Date: " & Now() & vbCrLf & _
                          "From: " & objMail.SenderEmailAddress & vbCrLf & _
                          "Subject: " & strSubject & vbCrLf & _
                          "Attachments: " & objMail.Attachments.Count & vbCrLf

            strMatchType = GetMatchType(strSubject)

            If strMatchType <> "" Then
                strDebugInfo = strDebugInfo & "MATCH: YES - " & strMatchType & vbCrLf
                intSavedCount = 0

                For Each objAttachment In objMail.Attachments
                    strFileName = objAttachment.FileName

                    If IsTargetFile(strFileName) Then
                        strSubFolder = GetSubFolder(strMatchType)

                        If strSubFolder <> "" Then
                            If Not FolderExists(SAVE_PATH & strSubFolder) Then
                                MkDir SAVE_PATH & strSubFolder
                            End If
                            strFullPath = SAVE_PATH & strSubFolder & "\" & strFileName
                        Else
                            strFullPath = SAVE_PATH & strFileName
                        End If

                        objAttachment.SaveAsFile strFullPath
                        intSavedCount = intSavedCount + 1
                        strDebugInfo = strDebugInfo & "SAVED: " & strFileName & vbCrLf
                    End If
                Next objAttachment

                strDebugInfo = strDebugInfo & "TOTAL SAVED: " & intSavedCount
                If ENABLE_LOGGING Then WriteLog strDebugInfo
            Else
                strDebugInfo = strDebugInfo & "MATCH: NO - skipped"
                If ENABLE_LOGGING Then WriteLog strDebugInfo
            End If
        End If

        Set objMail = Nothing
    Next strID

    Set objNS = Nothing
    Exit Sub

ErrorHandler:
    Dim strError As String
    strError = "=== ERROR ===" & vbCrLf & _
               "Date: " & Now() & vbCrLf & _
               "Error: " & Err.Description
    If ENABLE_LOGGING Then WriteLog strError

End Sub

'===============================================================================
' MATCH TYPE
'===============================================================================
Private Function GetMatchType(ByVal strSubject As String) As String
    GetMatchType = ""

    If CyrInStr(strSubject, "оборачиваемость") > 0 And CyrInStr(strSubject, "группам товара") > 0 Then
        GetMatchType = "TURNOVER"
        Exit Function
    End If
    
    If CyrInStr(strSubject, "Обувь остатки") > 0 And CyrInStr(strSubject, "оборачиваемость") > 0 Then
        GetMatchType = "TURNOVER"
        Exit Function
    End If

    If CyrInStr(strSubject, "приросту") > 0 And CyrInStr(strSubject, "регион") > 0 And _
       CyrInStr(strSubject, "аксессуар") = 0 And CyrInStr(strSubject, "магазин") = 0 Then
        GetMatchType = "REGIONS"
        Exit Function
    End If

    If CyrInStr(strSubject, "приросту") > 0 And CyrInStr(strSubject, "аксессуар") > 0 And _
       CyrInStr(strSubject, "магазин") > 0 Then
        GetMatchType = "ACCESSORIES"
        Exit Function
    End If

End Function

Private Function CyrInStr(ByVal strSource As String, ByVal strSearch As String) As Long
    CyrInStr = InStr(1, strSource, strSearch, vbTextCompare)
End Function

Private Function GetSubFolder(ByVal strMatchType As String) As String
    Select Case strMatchType
        Case "TURNOVER": GetSubFolder = "Обувь остатки и оборачиваемость по группам товара"
        Case "REGIONS": GetSubFolder = "Отчет по приросту регионы"
        Case "ACCESSORIES": GetSubFolder = "Отчет по приросту аксессуаров по магазинам"
        Case Else: GetSubFolder = ""
    End Select
End Function

Private Function IsTargetFile(ByVal strFileName As String) As Boolean
    Dim strLower As String
    strLower = LCase(strFileName)
    IsTargetFile = (Right(strLower, 5) = ".xlsx") Or (Right(strLower, 4) = ".xls") Or _
                   (Right(strLower, 5) = ".xlsm") Or (Right(strLower, 4) = ".pdf")
End Function

Private Function FolderExists(ByVal strPath As String) As Boolean
    On Error Resume Next
    FolderExists = (GetAttr(strPath) And vbDirectory) = vbDirectory
    On Error GoTo 0
End Function

Private Sub WriteLog(ByVal strMessage As String)
    On Error Resume Next
    Dim strLogFile As String
    Dim intFileNum As Integer
    strLogFile = LOG_PATH & "outlook_macro_" & Format(Now(), "YYYYMMDD") & ".log"
    intFileNum = FreeFile
    Open strLogFile For Append As #intFileNum
    Print #intFileNum, String(80, "=")
    Print #intFileNum, strMessage
    Print #intFileNum, String(80, "=")
    Print #intFileNum, ""
    Close #intFileNum
    On Error GoTo 0
End Sub

'===============================================================================
' TEST MACRO - Run manually: Alt+F11, F5, select TestMacro
'===============================================================================
Public Sub TestMacro()
    Dim strResult As String
    strResult = "=== KARI VBA v6.0 TEST ===" & vbCrLf & vbCrLf
    
    Dim arrTargets(2) As String
    arrTargets(0) = "Обувь остатки и оборачиваемость по группам товара"
    arrTargets(1) = "Отчет по приросту регионы"
    arrTargets(2) = "Отчет по приросту аксессуаров по магазинам"
    
    Dim i As Integer
    For i = 0 To 2
        Dim strMatch As String
        strMatch = GetMatchType(arrTargets(i))
        If strMatch <> "" Then
            strResult = strResult & "OK: " & arrTargets(i) & " -> " & strMatch & vbCrLf
        Else
            strResult = strResult & "FAIL: " & arrTargets(i) & vbCrLf
        End If
    Next i
    
    strResult = strResult & vbCrLf & "Paths:" & vbCrLf
    strResult = strResult & "Save: " & SAVE_PATH & vbCrLf
    strResult = strResult & "Logs: " & LOG_PATH & vbCrLf
    
    MsgBox strResult, vbInformation, "KARI Test v6.0"
End Sub

'===============================================================================
' SCAN INBOX - Shows last 10 emails with proper encoding
'===============================================================================
Public Sub ScanInbox()
    Dim objNS As Outlook.NameSpace
    Dim objInbox As Outlook.MAPIFolder
    Dim objItems As Outlook.Items
    Dim objMail As Object
    Dim strResult As String
    Dim i As Integer
    Dim intCount As Integer

    Set objNS = Application.GetNamespace("MAPI")
    Set objInbox = objNS.GetDefaultFolder(olFolderInbox)
    Set objItems = objInbox.Items
    objItems.Sort "[ReceivedTime]", True

    strResult = "=== LAST 10 EMAILS (v6.0) ===" & vbCrLf & vbCrLf
    intCount = 0

    For i = 1 To objItems.Count
        If intCount >= 10 Then Exit For

        If TypeName(objItems(i)) = "MailItem" Then
            Set objMail = objItems(i)
            intCount = intCount + 1

            Dim strSubject As String
            Dim strMatch As String
            strSubject = GetSubjectSafe(objMail)
            strMatch = GetMatchType(strSubject)

            If strMatch <> "" Then
                strResult = strResult & ">>> MATCH [" & strMatch & "]" & vbCrLf
            Else
                strResult = strResult & "skip" & vbCrLf
            End If

            strResult = strResult & "Subject: " & strSubject & vbCrLf
            strResult = strResult & "Date: " & objMail.ReceivedTime & vbCrLf & vbCrLf

            Set objMail = Nothing
        End If
    Next i

    MsgBox strResult, vbInformation, "KARI: Inbox Scan v6.0"
End Sub
